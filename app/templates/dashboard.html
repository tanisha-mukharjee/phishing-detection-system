<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root{
            --bg1: linear-gradient(135deg, #4e54c8, #8f94fb);
            --glass: rgba(255,255,255,0.18);
            --text: #fff;
            --muted: rgba(255,255,255,0.85);
        }
        body {
            margin: 0;
            padding: 24px;
            font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial;
            background: var(--bg1);
            color: var(--text);
            transition: background 0.25s ease, color 0.25s ease;
        }

        body.dark {
            background: #0f1724;
            color: #e6eef8;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--glass);
            border-radius: 14px;
            padding: 18px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }

        header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
        }

        header .title {
            display:flex;
            gap:12px;
            align-items:center;
        }

        header img {
            width: 48px;
            height: 48px;
            border-radius: 8px;
        }

        h1 {
            font-size: 26px;
            margin: 0;
            color: var(--text);
        }

        .controls {
            display:flex;
            gap:12px;
            align-items:center;
            flex-wrap:wrap;
        }

        /* Updated search bar */
        .search {
            display:flex;
            align-items:center;
            gap:10px;
            background: rgba(255,255,255,0.25);
            padding:10px 14px;
            border-radius:12px;
            backdrop-filter:blur(6px);
        }

        .search input {
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 16px;
            width: 280px;
            font-weight: 500;
        }

        .search input::placeholder {
            color: rgba(255,255,255,0.85);
        }

        #searchBtn {
            padding: 8px 16px;
            border-radius: 10px;
            background: rgba(255,255,255,0.35);
            border: none;
            color: #fff;
            cursor:pointer;
            font-weight:600;
        }

        #searchBtn:hover {
            background: rgba(255,255,255,0.55);
        }

        .btn {
            background: #ffcc00;
            color:#222;
            padding:8px 12px;
            border-radius:8px;
            cursor:pointer;
            border: none;
            font-weight:600;
        }

        .btn.ghost {
            background: transparent;
            color: var(--text);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .filters button {
            padding:6px 10px;
            border-radius:8px;
            border:none;
            cursor:pointer;
            background: rgba(0,0,0,0.12);
            color: var(--text);
        }

        .filters button.active {
            background: rgba(255,255,255,0.18);
            box-shadow:0 4px 12px rgba(0,0,0,0.25);
        }

        .main {
            display:grid;
            grid-template-columns: 1fr 320px;
            gap:20px;
            margin-top:20px;
        }

        .table-wrapper {
            background: rgba(255,255,255,0.05);
            border-radius:10px;
            overflow:hidden;
        }

        table {
            width:100%;
            border-collapse:collapse;
        }

        thead th {
            text-align:left;
            padding:12px;
            background:rgba(255,255,255,0.1);
            font-size:15px;
        }

        tbody td {
            padding:10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        tr.phishing {
            background: rgba(255,0,0,0.14);
        }

        tr.safe {
            background: rgba(0,255,0,0.10);
        }

        .muted {
            color: var(--muted);
            font-size: 13px;
        }

        .card {
            background: rgba(255,255,255,0.06);
            padding:12px;
            border-radius:10px;
        }

        .pagination {
            display:flex;
            gap:8px;
            justify-content:center;
            margin-top:12px;
        }

        .page-num {
            padding:6px 12px;
            border-radius:8px;
            background:rgba(255,255,255,0.1);
            cursor:pointer;
        }

        .page-num.active {
            background:rgba(255,255,255,0.3);
            font-weight:700;
        }

        footer {
            text-align:center;
            margin-top:20px;
        }

        @media (max-width: 920px){
            .main { grid-template-columns:1fr; }
        }
    </style>
</head>

<body>
<div class="container">

    <header>
        <div class="title">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo" style="width:48px;height:48px;border-radius:8px;">
            <div>
                <h1>Admin Dashboard</h1>
                <div class="muted">Phishing Detection Logs</div>
            </div>
        </div>

        <div class="controls">
            <div class="search">
                <input id="searchBox" placeholder="Search URL...">
                <button id="searchBtn">Search</button>
            </div>

            <div class="filters">
                <button data-status="all" class="filterBtn active">All</button>
                <button data-status="phishing" class="filterBtn">Phishing</button>
                <button data-status="safe" class="filterBtn">Safe</button>
            </div>

            <button id="downloadBtn" class="btn">Download CSV</button>
            <button id="darkToggle" class="btn ghost">Dark</button>
        </div>
    </header>

    <div class="main">
        <div>
            <div class="table-wrapper card">
                <table>
                    <thead>
                    <tr>
                        <th>URL</th>
                        <th>Prediction</th>
                        <th>Timestamp</th>
                    </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <aside class="right-panel">
            <div class="card">
                <canvas id="pieChart" height="200"></canvas>
            </div>

            <div class="card">
                <div style="display:flex;justify-content:space-between;">
                    <div>
                        <div class="muted">Total Logs</div>
                        <div id="totalCount" style="font-weight:700;font-size:22px;">0</div>
                    </div>
                    <div>
                        <div class="muted">Phishing</div>
                        <div id="phishCount" style="font-weight:700;font-size:22px;color:#ff6b6b;">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="muted">Per Page</div>
                <select id="perPageSelect">
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="25">25</option>
                </select>
            </div>
        </aside>
    </div>

    <footer>
        <a href="/" class="muted" style="text-decoration:none;">‚Üê Back to Home</a>
    </footer>

</div>

<script>
    let state = { page: 1, per_page: 15, q:'', status:'all' };

    const tableBody = document.getElementById('tableBody');
    const pagination = document.getElementById('pagination');
    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    const filterBtns = document.querySelectorAll('.filterBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const perPageSelect = document.getElementById('perPageSelect');
    const totalCountEl = document.getElementById('totalCount');
    const phishCountEl = document.getElementById('phishCount');
    const darkToggle = document.getElementById('darkToggle');

    const ctx = document.getElementById('pieChart').getContext('2d');
    let pieChart = new Chart(ctx, {
        type:'pie',
        data:{ labels:['Safe','Phishing'], datasets:[{ data:[0,0] }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    function applyDarkMode(){
        if(localStorage.getItem("dashboard_dark")==="1"){
            document.body.classList.add("dark");
            darkToggle.textContent="Light";
        } else {
            document.body.classList.remove("dark");
            darkToggle.textContent="Dark";
        }
    }
    applyDarkMode();

    darkToggle.onclick = () => {
        localStorage.setItem("dashboard_dark",
            document.body.classList.contains("dark") ? "0" : "1"
        );
        applyDarkMode();
    };

    async function fetchLogs(){
        const res = await fetch(`/api/logs?page=${state.page}&per_page=${state.per_page}&q=${state.q}&status=${state.status}`);
        const data = await res.json();
        renderTable(data.logs);
        renderPagination(data.page, data.total_pages);
        totalCountEl.textContent = data.total;
    }

    async function fetchStats(){
        const res = await fetch('/api/stats');
        const data = await res.json();
        pieChart.data.datasets[0].data = [data.safe, data.phishing];
        pieChart.update();
        phishCountEl.textContent = data.phishing;
        totalCountEl.textContent = data.total;
    }

    function renderTable(logs){
        tableBody.innerHTML = '';
        if (!logs.length){
            tableBody.innerHTML = '<tr><td colspan="3" class="muted">No logs found</td></tr>';
            return;
        }

        for(const log of logs){
            const tr = document.createElement('tr');
            tr.className = /Phishing/i.test(log.prediction) ? 'phishing' : 'safe';
            tr.innerHTML = `
                <td>${log.url}</td>
                <td>${log.prediction}</td>
                <td>${log.timestamp}</td>
            `;
            tableBody.appendChild(tr);
        }
    }

    function renderPagination(page, totalPages){
        pagination.innerHTML = '';
        if(totalPages < 2) return;

        const addBtn = (p, label=p) => {
            const b = document.createElement('button');
            b.textContent = label;
            b.className = 'page-num' + (p===page ? ' active':'');
            b.onclick = () => { state.page=p; reload(); };
            pagination.appendChild(b);
        };

        if(page>1) addBtn(page-1,'Prev');
        for(let i=1;i<=totalPages;i++){
            if(i<=3 || i>totalPages-3 || Math.abs(i-page)<=2){
                addBtn(i);
            }
        }
        if(page<totalPages) addBtn(page+1,'Next');
    }

    searchBtn.onclick = () => {
        state.q = searchBox.value.trim();
        state.page=1;
        reload();
    };

    searchBox.onkeyup = e => { if(e.key==='Enter') searchBtn.click(); };

    filterBtns.forEach(btn=>{
        btn.onclick = ()=>{
            filterBtns.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            state.status = btn.dataset.status;
            state.page = 1;
            reload();
        };
    });

    perPageSelect.onchange = ()=>{
        state.per_page = perPageSelect.value;
        state.page=1;
        reload();
    };

    downloadBtn.onclick = () => {
        window.location = `/download_logs?q=${state.q}&status=${state.status}`;
    };

    async function reload(){
        await fetchLogs();
        await fetchStats();
    }
    reload();
</script>

</body>
</html>
